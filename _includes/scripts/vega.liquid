{% if page.chart and page.chart.vega_lite %}
  {% assign vega = site.third_party_libraries.vega %}
  {% assign vega_js_url = vega.url.js | replace: '{{version}}', vega.version %}
  <script
    defer
    src="{{ vega_js_url }}"
    integrity="{{ vega.integrity.js }}"
    crossorigin="anonymous"
  ></script>
  {% assign vega_lite = site.third_party_libraries['vega-lite'] %}
  {% assign vega_lite_js_url = vega_lite.url.js | replace: '{{version}}', vega_lite.version %}
  <script
    defer
    src="{{ vega_lite_js_url }}"
    integrity="{{ vega_lite.integrity.js }}"
    crossorigin="anonymous"
  ></script>
  {% assign vega_embed = site.third_party_libraries['vega-embed'] %}
  {% assign vega_embed_js_url = vega_embed.url.js | replace: '{{version}}', vega_embed.version %}
  <script
    defer
    src="{{ vega_embed_js_url }}"
    integrity="{{ vega_embed.integrity.js }}"
    crossorigin="anonymous"
  ></script>

  <script>
    let vegaTheme = determineComputedTheme();

    /* Create vega lite chart as another node and hide the code block, appending the vega lite node after it
       this is done to enable retrieving the code again when changing theme between light/dark */
    document.addEventListener('readystatechange', () => {
      if (document.readyState === 'complete') {
        document.querySelectorAll('pre>code.language-vega_lite').forEach((elem) => {
          const jsonData = elem.textContent;
          const backup = elem.parentElement;
          backup.classList.add('unloaded');
          /* create vega lite node */
          let chartElement = document.createElement('div');
          chartElement.classList.add('vega-lite');
          backup.after(chartElement);

          /* Embed the visualization in the container */
          if (vegaTheme === 'dark') {
            vegaEmbed(chartElement, JSON.parse(jsonData), { theme: 'dark' });
          } else {
            vegaEmbed(chartElement, JSON.parse(jsonData));
          }
        });
      }
    });
  </script>
{% endif %}
