---
layout: default
---
<style>
  .secret-post__form {
    margin-top: 1rem;
    padding: 1.2rem;
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 0.5rem;
    background-color: rgba(0, 0, 0, 0.02);
  }

  .secret-post__form label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1rem;
  }

  .secret-post__form input[type="password"] {
    width: 100%;
    font-size: 1rem;
    padding: 0.5rem 0.65rem;
    margin: 0.35rem 0 0.75rem;
  }

  .secret-post__form button {
    font-size: 0.95rem;
  }

  .secret-post__error {
    color: #b00020;
    margin-top: 0.5rem;
  }

  .secret-post__content {
    margin-top: 1.5rem;
  }
</style>

<div class="post">
  <h1>{{ page.title }}</h1>
  <p class="post-meta">
    {{ page.date | date: '%B %d, %Y' }}
  </p>

  <div
    id="secret-post"
    data-ciphertext="{{ page.ciphertext | strip_newlines }}"
    data-tag="{{ page.tag | strip_newlines }}"
    data-salt="{{ page.salt | strip_newlines }}"
    data-iv="{{ page.iv | strip_newlines }}"
    data-iterations="{{ page.kdf.iterations | default: 210000 }}"
  >
    <div class="secret-post__form" id="secret-post-form">
      <label for="secret-password">enter passcode for this post</label>
      <input
        id="secret-password"
        type="password"
        name="password"
        autocomplete="off"
        placeholder="passcode"
      />
      <button type="button" id="secret-submit" class="btn btn-primary btn-sm">
        unlock
      </button>
      <div class="secret-post__error" id="secret-error" hidden>
        incorrect passcode, try again.
      </div>
      <div class="secret-post__error" id="secret-webcrypto-error" hidden>
        this browser does not support the required encryption APIs.
      </div>
    </div>

    <div class="secret-post__content" id="secret-post-content" hidden></div>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById('secret-post');
    if (!container) return;
    if (!window.crypto || !window.crypto.subtle) {
      document.getElementById('secret-webcrypto-error').hidden = false;
      return;
    }

    const ciphertext = container.dataset.ciphertext;
    const tag = container.dataset.tag;
    const salt = container.dataset.salt;
    const iv = container.dataset.iv;
    const iterations = parseInt(container.dataset.iterations || '210000', 10);

    const ui = {
      input: document.getElementById('secret-password'),
      submit: document.getElementById('secret-submit'),
      error: document.getElementById('secret-error'),
      content: document.getElementById('secret-post-content'),
      form: document.getElementById('secret-post-form'),
    };

    function base64ToBytes(b64) {
      const binary = window.atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i += 1) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function concatBytes(a, b) {
      const merged = new Uint8Array(a.length + b.length);
      merged.set(a, 0);
      merged.set(b, a.length);
      return merged;
    }

    async function deriveKey(password, saltBytes) {
      const enc = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        'raw',
        enc.encode(password),
        'PBKDF2',
        false,
        ['deriveKey']
      );
      return window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: saltBytes,
          iterations,
          hash: 'SHA-256',
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );
    }

    async function decrypt(password) {
      const saltBytes = base64ToBytes(salt);
      const ivBytes = base64ToBytes(iv);
      const cipherBytes = base64ToBytes(ciphertext);
      const tagBytes = base64ToBytes(tag);
      const encryptedBytes = concatBytes(cipherBytes, tagBytes);
      const key = await deriveKey(password, saltBytes);
      const decrypted = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: ivBytes, tagLength: 128 },
        key,
        encryptedBytes
      );
      return new TextDecoder().decode(decrypted);
    }

    async function handleSubmit() {
      ui.error.hidden = true;
      try {
        const html = await decrypt(ui.input.value);
        ui.content.innerHTML = html;
        ui.content.hidden = false;
        ui.form.hidden = true;
      } catch (error) {
        console.error('Failed to decrypt secret post', error);
        ui.error.hidden = false;
      } finally {
        ui.input.value = '';
      }
    }

    ui.submit.addEventListener('click', handleSubmit);
    ui.input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleSubmit();
      }
    });
  })();
</script>
